<!-- templates/index.html -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-upload"></i> File Upload</h5>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#passwordModal">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </div>
            <div class="card-body">
                <!-- Upload Form -->
                <form id="uploadForm" class="mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="file" class="form-control" id="fileInput" multiple>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="bucketSelect" required>
                                <option value="">Select S3 Bucket</option>
                                {% for bucket in config.available_buckets %}
                                    <option value="{{ bucket }}" {% if bucket == config.default_bucket %}selected{% endif %}>
                                        {{ bucket }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">
                        <i class="fas fa-upload"></i> Upload Files
                    </button>
                </form>

                <!-- Drop Zone -->
                <div class="drop-zone" id="dropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                    <p class="mt-3 text-muted">Drop files here or click to upload</p>
                </div>
            </div>
        </div>

        <!-- File List -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> S3 Objects</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select class="form-select" id="listBucketSelect" onchange="loadFileList()">
                        <option value="">Select bucket to view files</option>
                        {% for bucket in config.available_buckets %}
                            <option value="{{ bucket }}">{{ bucket }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="fileList" class="file-list">
                    <p class="text-muted">Select a bucket to view files</p>
                </div>

                <nav id="pagination" class="mt-3" style="display: none;">
                    <ul class="pagination pagination-sm justify-content-center" id="paginationList">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-terminal"></i> Script Logs & AWS Output</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()" title="Clear Logs">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div id="logWindow" class="log-window">
                    <div class="log-entry info">
                        <small>[${new Date().toLocaleTimeString()}]</small>
                        Application started. Ready for file uploads and AWS operations.
                    </div>
                    <div class="log-entry info">
                        <small>[${new Date().toLocaleTimeString()}]</small>
                        Script outputs, boto3 logs, and ETL messages will appear here...
                    </div>
                </div>
            </div>
            <div class="card-footer p-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Real-time logs from AWS token script, S3 operations, and ETL processes
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="passwordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">
                            This will be tested against your AWS token script before saving.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let socket = null;
let currentPage = 1;
let currentBucket = '';

// Initialize Socket.IO connection
function initSocket() {
    socket = io();

    socket.on('connect', function() {
        addLogEntry('Connected to server', 'info');
    });

    socket.on('log_message', function(data) {
        addLogEntry(data.message, getLogLevel(data.message));
    });

    socket.on('disconnect', function() {
        addLogEntry('Disconnected from server', 'warning');
    });
}

function getLogLevel(message) {
    if (message.toLowerCase().includes('error')) return 'error';
    if (message.toLowerCase().includes('warning')) return 'warning';
    return 'info';
}

function addLogEntry(message, level = 'info') {
    const logWindow = document.getElementById('logWindow');
    const entry = document.createElement('div');
    entry.className = `log-entry ${level}`;
    entry.innerHTML = `<small>[${new Date().toLocaleTimeString()}]</small> ${message}`;

    logWindow.appendChild(entry);
    logWindow.scrollTop = logWindow.scrollHeight;

    // Keep only last 100 entries
    const entries = logWindow.querySelectorAll('.log-entry');
    if (entries.length > 100) {
        entries[0].remove();
    }
}

// File upload handling
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    uploadFiles();
});

function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const bucket = document.getElementById('bucketSelect').value;

    if (!bucket) {
        alert('Please select a bucket');
        return;
    }

    if (!fileInput.files.length) {
        alert('Please select files to upload');
        return;
    }

    Array.from(fileInput.files).forEach(file => {
        uploadFile(file, bucket);
    });

    // Clear the input
    fileInput.value = '';
}

function uploadFile(file, bucket) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('bucket', bucket);

    addLogEntry(`Starting upload: ${file.name} (${formatBytes(file.size)})`, 'info');

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogEntry(`Upload completed: ${file.name}`, 'info');
            // Refresh file list if we're viewing the same bucket
            if (currentBucket === bucket) {
                loadFileList();
            }
        } else {
            addLogEntry(`Upload failed: ${file.name} - ${data.message}`, 'error');
        }
    })
    .catch(error => {
        addLogEntry(`Upload error: ${file.name} - ${error.message}`, 'error');
    });
}

// Drag and drop functionality
function setupDropZone() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        const bucket = document.getElementById('bucketSelect').value;
        if (!bucket) {
            alert('Please select a bucket first');
            return;
        }

        Array.from(e.dataTransfer.files).forEach(file => {
            uploadFile(file, bucket);
        });
    });
}

// File list management
function loadFileList(page = 1) {
    const bucket = document.getElementById('listBucketSelect').value;
    if (!bucket) {
        document.getElementById('fileList').innerHTML = '<p class="text-muted">Select a bucket to view files</p>';
        document.getElementById('pagination').style.display = 'none';
        return;
    }

    currentBucket = bucket;
    currentPage = page;

    addLogEntry(`Loading files from ${bucket} (page ${page})`, 'info');

    fetch(`/list-objects?bucket=${bucket}&page=${page}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFileList(data.objects);
                setupPagination(data.pagination);
            } else {
                addLogEntry(`Failed to load files: ${data.message}`, 'error');
                document.getElementById('fileList').innerHTML = `<p class="text-danger">${data.message}</p>`;
            }
        })
        .catch(error => {
            addLogEntry(`Error loading files: ${error.message}`, 'error');
        });
}

function displayFileList(objects) {
    const fileList = document.getElementById('fileList');

    if (objects.length === 0) {
        fileList.innerHTML = '<p class="text-muted">No files found in this bucket</p>';
        return;
    }

    const html = objects.map(obj => `
        <div class="border-bottom py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${obj.key}</strong><br>
                    <small class="text-muted">
                        <i class="fas fa-calendar"></i> ${new Date(obj.last_modified).toLocaleString()}
                        <i class="fas fa-weight ms-2"></i> ${formatBytes(obj.size)}
                    </small>
                </div>
                <div>
                    <span class="badge bg-secondary">${obj.etag}</span>
                </div>
            </div>
        </div>
    `).join('');

    fileList.innerHTML = html;
}

function setupPagination(pagination) {
    const paginationContainer = document.getElementById('pagination');
    const paginationList = document.getElementById('paginationList');

    if (pagination.pages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }

    paginationContainer.style.display = 'block';

    let html = '';

    // Previous button
    if (pagination.page > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadFileList(${pagination.page - 1})">Previous</a></li>`;
    }

    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);

    for (let i = startPage; i <= endPage; i++) {
        const active = i === pagination.page ? 'active' : '';
        html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadFileList(${i})">${i}</a></li>`;
    }

    // Next button
    if (pagination.page < pagination.pages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadFileList(${pagination.page + 1})">Next</a></li>`;
    }

    paginationList.innerHTML = html;
}

// Utility functions
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// Password change
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const newPassword = document.getElementById('newPassword').value;
    const formData = new FormData();
    formData.append('new_password', newPassword);

    addLogEntry('Testing new password...', 'info');

    fetch('/change-password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogEntry('Password updated successfully', 'info');
            bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
            document.getElementById('newPassword').value = '';
        } else {
            addLogEntry(`Password update failed: ${data.message}`, 'error');
            alert(`Failed to update password: ${data.message}`);
        }
    })
    .catch(error => {
        addLogEntry(`Password update error: ${error.message}`, 'error');
        alert(`Error updating password: ${error.message}`);
    });
});

// Token refresh
function refreshTokens() {
    addLogEntry('Refreshing AWS tokens...', 'info');

    fetch('/refresh-tokens', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogEntry('AWS tokens refreshed successfully', 'info');
        } else {
            addLogEntry(`Token refresh failed: ${data.message}`, 'error');
            alert(`Failed to refresh tokens: ${data.message}`);
        }
    })
    .catch(error => {
        addLogEntry(`Token refresh error: ${error.message}`, 'error');
        alert(`Error refreshing tokens: ${error.message}`);
    });
}

// Clear logs function
function clearLogs() {
    const logWindow = document.getElementById('logWindow');
    logWindow.innerHTML = `
        <div class="log-entry info">
            <small>[${new Date().toLocaleTimeString()}]</small>
            Logs cleared. Ready for new operations.
        </div>
    `;
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initSocket();
    setupDropZone();

    // Load initial file list if a bucket is pre-selected
    const listBucket = document.getElementById('listBucketSelect');
    if (listBucket.value) {
        loadFileList();
    }

    // Add some sample log entries to show the format
    addLogEntry('WebSocket connection established', 'info');
    addLogEntry('Monitoring AWS token script outputs...', 'info');
});
</script>
{% endblock %}