<!DOCTYPE html>
<html>
<head>
    <title>Protected Page</title>
    <meta charset="UTF-8">
</head>
<body>
    <h2>Protected Page</h2>
    <p>Welcome, {{ username }}!</p>
    <a href="{{ url_for('logout') }}">Logout</a>

    <!-- Auto-logout on inactivity -->
    <script>
        let inactivityTimeout;
        let warningTimeout;
        const INACTIVITY_LIMIT = 30 * 60 * 1000; // 30 minutes (match server timeout)
        const WARNING_TIME = 5 * 60 * 1000; // Warn 5 minutes before

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            clearTimeout(warningTimeout);

            // Set warning timer
            warningTimeout = setTimeout(() => {
                const remaining = Math.floor((INACTIVITY_LIMIT - WARNING_TIME) / 60000);
                const stayLoggedIn = confirm(
                    `You will be logged out in ${remaining} minutes due to inactivity.\n\n` +
                    'Click OK to stay logged in.'
                );

                if (stayLoggedIn) {
                    // Ping server to refresh session
                    fetch('/api/check-session')
                        .then(response => {
                            if (response.ok) {
                                resetInactivityTimer();
                            } else {
                                window.location.href = '/logout';
                            }
                        })
                        .catch(() => {
                            window.location.href = '/logout';
                        });
                } else {
                    window.location.href = '/logout';
                }
            }, INACTIVITY_LIMIT - WARNING_TIME);

            // Set logout timer
            inactivityTimeout = setTimeout(() => {
                alert('You have been logged out due to inactivity.');
                window.location.href = '/logout';
            }, INACTIVITY_LIMIT);
        }

        // Track user activity
        const activityEvents = ['mousedown', 'keypress', 'scroll', 'touchstart', 'click', 'mousemove'];
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });

        // Start tracking
        resetInactivityTimer();

        // Periodically check session status
        setInterval(() => {
            fetch('/api/check-session')
                .catch(() => {
                    // Session expired, redirect to login
                    alert('Your session has expired. Please log in again.');
                    window.location.href = '/login';
                });
        }, 5 * 60 * 1000); // Check every 5 minutes
    </script>
</body>
</html>