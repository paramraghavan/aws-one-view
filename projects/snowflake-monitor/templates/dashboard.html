<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowflake Resource Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span>Snowflake Monitor</span>
            </div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active" data-section="overview">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>Overview</span>
            </li>
            <li class="nav-item highlight" data-section="attention">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span>Needs Attention</span>
            </li>
            <li class="nav-item" data-section="database">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
                <span>Database Deep Dive</span>
            </li>
            <li class="nav-item" data-section="warehouses">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
                    <rect x="9" y="9" width="6" height="6"/>
                    <line x1="9" y1="1" x2="9" y2="4"/>
                    <line x1="15" y1="1" x2="15" y2="4"/>
                    <line x1="9" y1="20" x2="9" y2="23"/>
                    <line x1="15" y1="20" x2="15" y2="23"/>
                </svg>
                <span>Warehouses</span>
            </li>
            <li class="nav-item" data-section="users">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" transform="translate(10, -2) scale(0.5)"/>
                </svg>
                <span>Users & Security</span>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <div class="refresh-control">
                <button id="settingsBtn" class="btn-settings" title="Configure thresholds">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </button>
                <button id="refreshBtn" class="btn-refresh">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Refresh Data
                </button>
                <span class="last-refresh">Last updated: <span id="lastRefresh">Never</span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Section -->
        <section id="overview" class="content-section active">
            <div class="section-header">
                <h1>Dashboard Overview</h1>
                <p class="section-subtitle">Real-time monitoring of your Snowflake environment</p>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon credits">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
                            <path d="M12 18V6"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Credits (30d) <span class="info-icon" data-tooltip="Snowflake credits consumed for compute. 1 credit ‚âà $2-4 depending on your contract. Warehouse size determines credits/hour: X-Small=1, Small=2, Medium=4, Large=8, etc.">‚ìò</span></span>
                        <span class="metric-value" id="totalCredits">--</span>
                        <span class="metric-unit">credits</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon storage">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Storage <span class="info-icon" data-tooltip="Total storage across all databases. Includes active data + Time Travel (default 1 day) + Fail-safe (7 days, cannot be disabled). Billed at ~$23-40/TB/month.">‚ìò</span></span>
                        <span class="metric-value" id="totalStorage">--</span>
                        <span class="metric-unit">TB</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon queries">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Queries (24h) <span class="info-icon" data-tooltip="Total queries executed in the last 24 hours across all warehouses. Includes SELECT, INSERT, UPDATE, DELETE, and DDL statements.">‚ìò</span></span>
                        <span class="metric-value" id="queryCount">--</span>
                        <span class="metric-unit">queries</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon warehouses">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
                            <rect x="9" y="9" width="6" height="6"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Active Warehouses <span class="info-icon" data-tooltip="Warehouses currently running (STARTED state). Suspended warehouses don't consume credits. Auto-suspend helps reduce costs.">‚ìò</span></span>
                        <span class="metric-value" id="activeWarehouses">--</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon time">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Avg Query Time <span class="info-icon" data-tooltip="Average query execution time. Includes queue time + compilation + execution. High values may indicate need for optimization or larger warehouses.">‚ìò</span></span>
                        <span class="metric-value" id="avgQueryTime">--</span>
                        <span class="metric-unit">sec</span>
                    </div>
                </div>
                
                <div class="metric-card alert">
                    <div class="metric-icon failed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </div>
                    <div class="metric-content">
                        <span class="metric-label">Failed Queries (24h) <span class="info-icon" data-tooltip="Queries that failed due to errors. Check error messages for common issues like syntax errors, permission denied, or resource constraints.">‚ìò</span></span>
                        <span class="metric-value" id="failedQueries">--</span>
                        <span class="metric-unit">failed</span>
                    </div>
                </div>
            </div>
            
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Credit Usage Trend (30 days)</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="costTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Storage Breakdown</h3>
                    </div>
                    <div class="storage-summary-row">
                        <div class="storage-summary-box">
                            <span class="storage-label">Total DB Storage</span>
                            <span class="storage-value" id="totalDbStorage">--</span>
                        </div>
                        <div class="storage-summary-box failsafe">
                            <span class="storage-label">Total Failsafe</span>
                            <span class="storage-value" id="totalFailsafeStorage">--</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="storageChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Needs Attention Section (combines bottlenecks, optimization, recommendations) -->
        <section id="attention" class="content-section">
            <div class="section-header">
                <h1>Needs Attention</h1>
                <p class="section-subtitle">Issues requiring action - sorted by priority</p>
            </div>
            
            <!-- Critical Issues -->
            <div class="attention-category critical">
                <h3>üî¥ Critical Issues</h3>
                <div class="attention-list" id="criticalIssues">
                    <p class="loading">Loading...</p>
                </div>
            </div>
            
            <!-- Warnings -->
            <div class="attention-category warning">
                <h3>üü° Warnings</h3>
                <div class="attention-list" id="warningIssues">
                    <p class="loading">Loading...</p>
                </div>
            </div>
            
            <!-- Optimization Opportunities -->
            <div class="attention-category optimization">
                <h3>üí° Optimization Opportunities</h3>
                <div class="attention-list" id="optimizationIssues">
                    <p class="loading">Loading...</p>
                </div>
            </div>
            
            <!-- Quick Wins Table -->
            <div class="data-table-section">
                <h3>Top 10 Queries to Fix</h3>
                <div class="table-container">
                    <table class="data-table" id="attentionQueriesTable">
                        <thead>
                            <tr>
                                <th>Query ID</th>
                                <th>Issue</th>
                                <th>User</th>
                                <th>Duration</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Database Deep Dive Section -->
        <section id="database" class="content-section">
            <div class="section-header">
                <h1>Database Deep Dive</h1>
                <p class="section-subtitle">Comprehensive analysis of a specific database - costs, performance, bottlenecks, and optimization</p>
            </div>
            
            <div class="database-selector-bar">
                <div class="selector-group">
                    <label for="databaseSelect">Select Database:</label>
                    <select id="databaseSelect" class="filter-select database-select">
                        <option value="">Loading databases...</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="dbDaysFilter">Time Period:</label>
                    <select id="dbDaysFilter" class="filter-select">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="60">Last 60 days</option>
                    </select>
                </div>
                <button id="loadDatabaseBtn" class="btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Analyze Database
                </button>
            </div>
            
            <!-- Database Overview Cards -->
            <div class="db-overview-section" id="dbOverviewSection" style="display: none;">
                <h3 class="subsection-title">Database Overview: <span id="selectedDbName">--</span></h3>
                
                <div class="metrics-grid metrics-grid-6">
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-label">Total Queries</span>
                            <span class="metric-value" id="dbTotalQueries">--</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-label">Active Users</span>
                            <span class="metric-value" id="dbActiveUsers">--</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-label">Avg Query Time</span>
                            <span class="metric-value" id="dbAvgQueryTime">--</span>
                            <span class="metric-unit">sec</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-content">
                            <span class="metric-label">TB Scanned</span>
                            <span class="metric-value" id="dbTbScanned">--</span>
                            <span class="metric-unit">TB</span>
                        </div>
                    </div>
                    <div class="metric-card storage-breakdown">
                        <div class="metric-content">
                            <span class="metric-label">Storage</span>
                            <span class="metric-value" id="dbStorage">--</span>
                            <span class="metric-unit" id="dbStorageUnit">GB</span>
                            <div class="storage-details">
                                <span class="storage-item">DB: <span id="dbStorageDb">--</span></span>
                                <span class="storage-item">Failsafe: <span id="dbStorageFailsafe">--</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card alert">
                        <div class="metric-content">
                            <span class="metric-label">Failed Queries</span>
                            <span class="metric-value" id="dbFailedQueries">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- Database Tabs -->
                <div class="db-tabs">
                    <button class="db-tab-btn active" data-tab="db-cost">Cost Analysis</button>
                    <button class="db-tab-btn" data-tab="db-performance">Performance</button>
                    <button class="db-tab-btn" data-tab="db-bottlenecks">Bottlenecks</button>
                    <button class="db-tab-btn" data-tab="db-tables">Tables</button>
                    <button class="db-tab-btn" data-tab="db-recommendations">Recommendations</button>
                </div>
                
                <!-- Cost Analysis Tab -->
                <div class="db-tab-content active" id="db-cost">
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Daily Query Volume & Cost</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbDailyVolumeChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Usage by Warehouse</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbWarehouseChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-section">
                        <h3>Top Users by Resource Consumption</h3>
                        <div class="table-container">
                            <table class="data-table" id="dbUserCostTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Queries</th>
                                        <th>Total Hours</th>
                                        <th>Avg Query Time</th>
                                        <th>TB Scanned</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="loading">Select a database to view data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Tab -->
                <div class="db-tab-content" id="db-performance">
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Query Volume by Hour</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbHourlyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Query Types Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbQueryTypeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-section">
                        <h3>Slow Queries (>30 seconds)</h3>
                        <div class="table-container">
                            <table class="data-table" id="dbSlowQueriesTable">
                                <thead>
                                    <tr>
                                        <th>Query ID</th>
                                        <th>User</th>
                                        <th>Warehouse</th>
                                        <th>Type</th>
                                        <th>Duration</th>
                                        <th>GB Scanned</th>
                                        <th>Queue Time</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="8" class="loading">Select a database to view data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Bottlenecks Tab -->
                <div class="db-tab-content" id="db-bottlenecks">
                    <div class="bottleneck-grid" id="dbBottleneckGrid">
                        <div class="bottleneck-card">
                            <div class="bottleneck-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <h4>Queue Time Issues</h4>
                            </div>
                            <div class="bottleneck-content" id="dbQueueIssues">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                        
                        <div class="bottleneck-card">
                            <div class="bottleneck-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/>
                                    <path d="M12 12v9"/>
                                    <path d="m8 17 4 4 4-4"/>
                                </svg>
                                <h4>Memory Spilling</h4>
                            </div>
                            <div class="bottleneck-content" id="dbSpillIssues">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                        
                        <div class="bottleneck-card">
                            <div class="bottleneck-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                <h4>Full Table Scans</h4>
                            </div>
                            <div class="bottleneck-content" id="dbScanIssues">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                        
                        <div class="bottleneck-card">
                            <div class="bottleneck-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                                <h4>Query Failures</h4>
                            </div>
                            <div class="bottleneck-content" id="dbFailureIssues">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-section">
                        <h3>Optimization Opportunities</h3>
                        <div class="table-container">
                            <table class="data-table" id="dbOptimizationTable">
                                <thead>
                                    <tr>
                                        <th>Query ID</th>
                                        <th>Issue Type</th>
                                        <th>User</th>
                                        <th>Warehouse</th>
                                        <th>Duration</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">Select a database to view data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tables Tab -->
                <div class="db-tab-content" id="db-tables">
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Queries by Schema</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbSchemaChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Table Size Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="dbTableSizeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-section">
                        <h3>Tables Analysis</h3>
                        <div class="table-container">
                            <table class="data-table" id="dbTablesTable">
                                <thead>
                                    <tr>
                                        <th>Schema</th>
                                        <th>Table</th>
                                        <th>Rows</th>
                                        <th>Size (GB)</th>
                                        <th>Clustering</th>
                                        <th>Last Updated</th>
                                        <th>Freshness</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="loading">Select a database to view data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations Tab -->
                <div class="db-tab-content" id="db-recommendations">
                    <div class="db-recommendations-container" id="dbRecommendationsContainer">
                        <p class="loading">Select a database to view recommendations</p>
                    </div>
                </div>
            </div>
            
            <!-- Empty state when no database selected -->
            <div class="empty-state" id="dbEmptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
                <h3>Select a Database to Analyze</h3>
                <p>Choose a database from the dropdown above to view comprehensive cost, performance, and optimization analysis.</p>
            </div>
        </section>

        <section id="warehouses" class="content-section">
            <div class="section-header">
                <h1>Warehouse Management</h1>
                <p class="section-subtitle">Monitor warehouse configurations and cluster performance</p>
            </div>
            
            <div class="info-banner">
                <div class="info-banner-icon">üí°</div>
                <div class="info-banner-content">
                    <strong>Understanding Warehouse Sizing:</strong> Warehouse size determines compute power and cost. 
                    Each size doubles both: X-Small (1 credit/hr) ‚Üí Small (2) ‚Üí Medium (4) ‚Üí Large (8) ‚Üí X-Large (16).
                    Larger warehouses process data faster but cost more. Use multi-cluster for concurrent query workloads.
                </div>
            </div>
            
            <div class="data-table-card">
                <div class="table-header">
                    <h3>Warehouse Configurations <span class="info-icon" data-tooltip="Shows all warehouses in your account. 'STARTED' warehouses are consuming credits. Enable auto-suspend (60-300s recommended) to reduce costs during idle periods.">‚ìò</span></h3>
                </div>
                <div class="table-container">
                    <table class="data-table" id="warehouseConfigTable">
                        <thead>
                            <tr>
                                <th>Warehouse</th>
                                <th>State <span class="info-icon" data-tooltip="STARTED = running and billing. SUSPENDED = not billing. RESIZING = changing size.">‚ìò</span></th>
                                <th>Size <span class="info-icon" data-tooltip="Compute power. Each size up = 2x performance and 2x cost. X-Small=1 cr/hr, Small=2, Medium=4, Large=8, X-Large=16.">‚ìò</span></th>
                                <th>Type</th>
                                <th>Min Clusters <span class="info-icon" data-tooltip="Minimum clusters always running when warehouse is started. More clusters = handle more concurrent queries.">‚ìò</span></th>
                                <th>Max Clusters <span class="info-icon" data-tooltip="Maximum clusters for auto-scaling. Set higher to handle query spikes. Each cluster multiplies your cost.">‚ìò</span></th>
                                <th>Scaling Policy <span class="info-icon" data-tooltip="STANDARD: Scales up quickly, good for interactive workloads. ECONOMY: Waits longer before scaling, saves money for batch jobs.">‚ìò</span></th>
                                <th>Auto Suspend <span class="info-icon" data-tooltip="Seconds of inactivity before warehouse suspends. 60-300s recommended. Set to 0 to disable (not recommended).">‚ìò</span></th>
                                <th>Auto Resume <span class="info-icon" data-tooltip="Automatically start warehouse when query arrives. Almost always should be TRUE.">‚ìò</span></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="charts-row">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3>Cluster Concurrency (7 days) <span class="info-icon" data-tooltip="Shows how many queries run simultaneously on each warehouse over time. High concurrency with queuing = need more clusters or larger warehouse. Low concurrency = may be over-provisioned.">‚ìò</span></h3>
                    </div>
                    <div class="concurrency-explainer">
                        <div class="explainer-item">
                            <span class="explainer-icon">üìà</span>
                            <span><strong>High peaks with queuing?</strong> Enable multi-cluster warehousing or increase max clusters</span>
                        </div>
                        <div class="explainer-item">
                            <span class="explainer-icon">üìâ</span>
                            <span><strong>Consistently low (&lt;2)?</strong> Consider downsizing warehouse or reducing auto-suspend time</span>
                        </div>
                        <div class="explainer-item">
                            <span class="explainer-icon">‚ö°</span>
                            <span><strong>Spiky pattern?</strong> Use STANDARD scaling policy for fast response to demand</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="clusterLoadChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users & Security Section (merged) -->
        <section id="users" class="content-section">
            <div class="section-header">
                <h1>Users & Security</h1>
                <p class="section-subtitle">User activity, resource consumption, and login security</p>
            </div>
            
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Active Users Trend</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Queries by Role</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="roleUsageChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="data-table-section">
                <h3>Top Users by Resource Usage</h3>
                <div class="table-container">
                    <table class="data-table" id="topUsersTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Queries</th>
                                <th>Total Hours</th>
                                <th>Avg Query Time</th>
                                <th>TB Scanned</th>
                                <th>Failed</th>
                                <th>Warehouses</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Loading user data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Security Section (merged in) -->
            <div class="subsection-divider">
                <h2>Login Security</h2>
            </div>
            
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Login Activity by Hour</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="loginPatternChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card alert-card">
                    <div class="chart-header">
                        <h3>Failed Login Attempts</h3>
                    </div>
                    <div class="failed-logins-list" id="failedLoginsList">
                        <p class="loading">Loading security data...</p>
                    </div>
                </div>
            </div>
            
            <div class="data-table-section">
                <h3>User Login Summary</h3>
                <div class="table-container">
                    <table class="data-table" id="loginSummaryTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Login Count</th>
                                <th>Unique IPs</th>
                                <th>Last Login</th>
                                <th>Failed Attempts</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">Loading login data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Threshold Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="settings-intro">Configure warning and critical thresholds for performance monitoring. Changes take effect on next data refresh.</p>
                
                <div class="settings-section">
                    <h3>üîç Query Performance</h3>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Slow Query Threshold</span>
                            <span class="setting-help" data-tooltip="Queries taking longer than this are flagged as slow. Consider optimizing queries exceeding this duration.">‚ìò</span>
                        </div>
                        <select id="thresholdSlowQuery" class="setting-select">
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds (default)</option>
                            <option value="60">60 seconds</option>
                            <option value="120">2 minutes</option>
                            <option value="300">5 minutes</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Full Scan Partition Threshold</span>
                            <span class="setting-help" data-tooltip="Queries scanning more than this percentage of partitions are flagged as full table scans. Add clustering keys to frequently scanned tables.">‚ìò</span>
                        </div>
                        <select id="thresholdPartitionScan" class="setting-select">
                            <option value="50">50% of partitions</option>
                            <option value="80">80% of partitions</option>
                            <option value="90" selected>90% of partitions (default)</option>
                            <option value="95">95% of partitions</option>
                            <option value="100">100% (all partitions)</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Compilation Time Warning</span>
                            <span class="setting-help" data-tooltip="High compilation time indicates complex queries or metadata issues. Simplify queries or check for too many micro-partitions.">‚ìò</span>
                        </div>
                        <select id="thresholdCompilation" class="setting-select">
                            <option value="3">3 seconds</option>
                            <option value="5" selected>5 seconds (default)</option>
                            <option value="10">10 seconds</option>
                            <option value="30">30 seconds</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>‚è±Ô∏è Queue & Concurrency</h3>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Queue Time Warning</span>
                            <span class="setting-help" data-tooltip="Queries waiting longer than this in queue indicate warehouse is overloaded. Consider scaling up or enabling multi-cluster.">‚ìò</span>
                        </div>
                        <select id="thresholdQueueWarning" class="setting-select">
                            <option value="5">5 seconds</option>
                            <option value="10" selected>10 seconds (default)</option>
                            <option value="20">20 seconds</option>
                            <option value="30">30 seconds</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Queue Time Critical</span>
                            <span class="setting-help" data-tooltip="Queue times exceeding this are critical - users experience significant delays. Immediate action recommended.">‚ìò</span>
                        </div>
                        <select id="thresholdQueueCritical" class="setting-select">
                            <option value="20">20 seconds</option>
                            <option value="30" selected>30 seconds (default)</option>
                            <option value="60">60 seconds</option>
                            <option value="120">2 minutes</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>üíæ Memory & Spilling</h3>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Local Spill Warning</span>
                            <span class="setting-help" data-tooltip="Data spilled to local SSD when memory is full. Moderate performance impact. Consider larger warehouse size.">‚ìò</span>
                        </div>
                        <select id="thresholdSpillLocal" class="setting-select">
                            <option value="10">10 GB</option>
                            <option value="25">25 GB</option>
                            <option value="50" selected>50 GB (default)</option>
                            <option value="100">100 GB</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Remote Spill Critical</span>
                            <span class="setting-help" data-tooltip="Data spilled to remote storage (S3/Azure) - VERY slow and expensive! Requires immediate warehouse upsize.">‚ìò</span>
                        </div>
                        <select id="thresholdSpillRemote" class="setting-select">
                            <option value="1">1 GB</option>
                            <option value="5">5 GB</option>
                            <option value="10" selected>10 GB (default)</option>
                            <option value="25">25 GB</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>‚ùå Failures</h3>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Failed Queries Warning</span>
                            <span class="setting-help" data-tooltip="Number of query failures before showing a warning. Check error messages for common issues.">‚ìò</span>
                        </div>
                        <select id="thresholdFailuresWarning" class="setting-select">
                            <option value="5">5 failures</option>
                            <option value="10">10 failures</option>
                            <option value="20" selected>20 failures (default)</option>
                            <option value="50">50 failures</option>
                        </select>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span>Failed Queries Critical</span>
                            <span class="setting-help" data-tooltip="High failure count indicates systemic issues - investigate immediately.">‚ìò</span>
                        </div>
                        <select id="thresholdFailuresCritical" class="setting-select">
                            <option value="50">50 failures</option>
                            <option value="100" selected>100 failures (default)</option>
                            <option value="200">200 failures</option>
                            <option value="500">500 failures</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetThresholds()">Reset to Defaults</button>
                <button class="btn btn-primary" onclick="saveThresholds()">Save & Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Query SQL Modal -->
    <div class="modal-overlay" id="queryModal">
        <div class="modal query-modal">
            <div class="modal-header">
                <h2>üìù Query Details</h2>
                <button class="modal-close" onclick="closeQueryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="query-sql-container">
                    <pre id="queryModalSQL"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="copyQueryToClipboard()">üìã Copy to Clipboard</button>
                <button class="btn btn-primary" onclick="closeQueryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay with Hourglass -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="hourglass">
                <div class="hourglass-top"></div>
                <div class="hourglass-bottom"></div>
                <div class="hourglass-sand"></div>
            </div>
            <span class="loading-text">Loading data...</span>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
