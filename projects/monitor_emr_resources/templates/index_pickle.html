<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Job Resource Monitor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        .status-error { background-color: #fff3cd; color: #856404; }
        .status-running { background-color: #cce7ff; color: #004085; }
        .table-container { max-height: 500px; overflow-y: auto; }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .loading { display: none; }
        .loading.show { display: block; }
        .tab-content { min-height: 400px; }
        .filter-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .no-data { text-align: center; padding: 40px; color: #6c757d; }
        .clear-state-section { background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mt-3 mb-4">
                    <i class="fas fa-server"></i> EMR Job Resource Monitor
                </h1>

                <!-- Configuration Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <label for="sparkUrl" class="form-label">Spark History Server URL</label>
                                <input type="text" class="form-control" id="sparkUrl"
                                       value="http://your-master-node:18080" placeholder="Enter Spark History Server URL">
                            </div>
                            <div class="col-md-5">
                                <label for="yarnUrl" class="form-label">YARN Resource Manager URL</label>
                                <input type="text" class="form-control" id="yarnUrl"
                                       value="http://your-master-node:8088" placeholder="Enter YARN Resource Manager URL">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i> Refresh Data
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoRefresh">
                                <label class="form-check-label" for="autoRefresh">
                                    Auto-refresh every 30 seconds
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- State Management Section -->
                <div class="clear-state-section">
                    <h6><i class="fas fa-database"></i> Resource State Management</h6>
                    <p class="small mb-2">Persistent tracking of maximum resource usage across restarts</p>
                    <button class="btn btn-warning btn-sm" onclick="clearAllState()">
                        <i class="fas fa-trash"></i> Clear All State
                    </button>
                    <span class="ms-2 small text-muted">Use this to reset all tracked maximum values</span>
                </div>

                <!-- Loading Indicator -->
                <div class="loading text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading job data...</p>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="jobTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="running-tab" data-bs-toggle="tab" data-bs-target="#running"
                                type="button" role="tab">
                            <i class="fas fa-play-circle"></i> Running Jobs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed"
                                type="button" role="tab">
                            <i class="fas fa-check-circle"></i> Completed Jobs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hourly-tab" data-bs-toggle="tab" data-bs-target="#hourly"
                                type="button" role="tab">
                            <i class="fas fa-chart-bar"></i> Hourly Aggregation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary"
                                type="button" role="tab">
                            <i class="fas fa-list"></i> Job Summary
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cluster-max-tab" data-bs-toggle="tab" data-bs-target="#cluster-max"
                                type="button" role="tab">
                            <i class="fas fa-server"></i> Cluster Max
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="job-max-tab" data-bs-toggle="tab" data-bs-target="#job-max"
                                type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Job Max
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="jobTabsContent">
                    <!-- Running Jobs Tab -->
                    <div class="tab-pane fade show active" id="running" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Running Jobs</h4>
                                <button class="btn btn-success btn-sm" onclick="downloadCSV('running')">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="runningTable">
                                    <thead>
                                        <tr id="runningTableHeader"></tr>
                                    </thead>
                                    <tbody id="runningTableBody"></tbody>
                                </table>
                                <div id="runningNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No running jobs found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Completed Jobs Tab -->
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Completed Jobs</h4>
                                <button class="btn btn-success btn-sm" onclick="downloadCSV('completed')">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="completedTable">
                                    <thead>
                                        <tr id="completedTableHeader"></tr>
                                    </thead>
                                    <tbody id="completedTableBody"></tbody>
                                </table>
                                <div id="completedNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No completed jobs found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Aggregation Tab -->
                    <div class="tab-pane fade" id="hourly" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Hourly Aggregation</h4>
                                <button class="btn btn-success btn-sm" onclick="downloadCSV('hourly')">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="hourlyTable">
                                    <thead>
                                        <tr id="hourlyTableHeader"></tr>
                                    </thead>
                                    <tbody id="hourlyTableBody"></tbody>
                                </table>
                                <div id="hourlyNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No hourly data found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Summary Tab -->
                    <div class="tab-pane fade" id="summary" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Job Summary</h4>
                            </div>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="summaryTable">
                                    <thead>
                                        <tr id="summaryTableHeader"></tr>
                                    </thead>
                                    <tbody id="summaryTableBody"></tbody>
                                </table>
                                <div id="summaryNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No summary data found</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cluster Max Tab -->
                    <div class="tab-pane fade" id="cluster-max" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-server"></i> Maximum Resource Usage by Cluster</h4>
                                <button class="btn btn-success btn-sm" onclick="downloadCSV('cluster_max')">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <p class="text-muted">Tracks the maximum memory and vCores used by each cluster/queue at any point in time (persists across restarts)</p>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="clusterMaxTable">
                                    <thead>
                                        <tr id="clusterMaxTableHeader"></tr>
                                    </thead>
                                    <tbody id="clusterMaxTableBody"></tbody>
                                </table>
                                <div id="clusterMaxNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No cluster maximum data found. Data will appear as jobs run.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Max Tab -->
                    <div class="tab-pane fade" id="job-max" role="tabpanel">
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-chart-line"></i> Maximum Resource Usage by Job</h4>
                                <button class="btn btn-success btn-sm" onclick="downloadCSV('job_max')">
                                    <i class="fas fa-download"></i> Download CSV
                                </button>
                            </div>
                            <p class="text-muted">Tracks the maximum memory and vCores used by each job/application at any point in time (persists across restarts)</p>
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="jobMaxTable">
                                    <thead>
                                        <tr id="jobMaxTableHeader"></tr>
                                    </thead>
                                    <tbody id="jobMaxTableBody"></tbody>
                                </table>
                                <div id="jobMaxNoData" class="no-data" style="display: none;">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No job maximum data found. Data will appear as jobs run.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let jobData = {};
        let autoRefreshInterval = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            
            // Setup auto-refresh
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000);
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });
        });

        function refreshData() {
            const sparkUrl = document.getElementById('sparkUrl').value;
            const yarnUrl = document.getElementById('yarnUrl').value;

            loadRunningJobs(sparkUrl, yarnUrl);
            loadCompletedJobs(sparkUrl, yarnUrl);
            loadHourlyAggregation(sparkUrl, yarnUrl);
            loadJobSummary(sparkUrl, yarnUrl);
            loadClusterMaxStats();
            loadJobMaxStats();
        }

        async function loadRunningJobs(sparkUrl, yarnUrl) {
            try {
                const response = await fetch(`/running_jobs?spark_url=${encodeURIComponent(sparkUrl)}&yarn_url=${encodeURIComponent(yarnUrl)}`);
                const data = await response.json();
                jobData.running = data;
                updateRunningTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading running jobs:', error);
            }
        }

        async function loadCompletedJobs(sparkUrl, yarnUrl) {
            try {
                const response = await fetch(`/completed_jobs?spark_url=${encodeURIComponent(sparkUrl)}&yarn_url=${encodeURIComponent(yarnUrl)}`);
                const data = await response.json();
                jobData.completed = data;
                updateCompletedTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading completed jobs:', error);
            }
        }

        async function loadHourlyAggregation(sparkUrl, yarnUrl) {
            try {
                const response = await fetch(`/hourly_aggregation?spark_url=${encodeURIComponent(sparkUrl)}&yarn_url=${encodeURIComponent(yarnUrl)}`);
                const data = await response.json();
                jobData.hourly = data;
                updateHourlyTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading hourly aggregation:', error);
            }
        }

        async function loadJobSummary(sparkUrl, yarnUrl) {
            try {
                const response = await fetch(`/job_summary?spark_url=${encodeURIComponent(sparkUrl)}&yarn_url=${encodeURIComponent(yarnUrl)}`);
                const data = await response.json();
                jobData.summary = data;
                updateSummaryTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading job summary:', error);
            }
        }

        async function loadClusterMaxStats() {
            try {
                const response = await fetch('/cluster_max_stats');
                const data = await response.json();
                updateClusterMaxTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading cluster max stats:', error);
            }
        }

        async function loadJobMaxStats() {
            try {
                const response = await fetch('/job_max_stats');
                const data = await response.json();
                updateJobMaxTable(data.data, data.columns);
            } catch (error) {
                console.error('Error loading job max stats:', error);
            }
        }

        function updateRunningTable(data, columns) {
            const noDataDiv = document.getElementById('runningNoData');
            const table = document.getElementById('runningTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('runningTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('runningTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function updateCompletedTable(data, columns) {
            const noDataDiv = document.getElementById('completedNoData');
            const table = document.getElementById('completedTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('completedTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('completedTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function updateHourlyTable(data, columns) {
            const noDataDiv = document.getElementById('hourlyNoData');
            const table = document.getElementById('hourlyTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('hourlyTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('hourlyTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function updateSummaryTable(data, columns) {
            const noDataDiv = document.getElementById('summaryNoData');
            const table = document.getElementById('summaryTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('summaryTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('summaryTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function updateClusterMaxTable(data, columns) {
            const noDataDiv = document.getElementById('clusterMaxNoData');
            const table = document.getElementById('clusterMaxTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('clusterMaxTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('clusterMaxTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => {
                    if (col === 'First Seen' || col === 'Last Updated') {
                        return `<td>${new Date(row[col]).toLocaleString()}</td>`;
                    }
                    return `<td>${row[col] || ''}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function updateJobMaxTable(data, columns) {
            const noDataDiv = document.getElementById('jobMaxNoData');
            const table = document.getElementById('jobMaxTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            const header = document.getElementById('jobMaxTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            const body = document.getElementById('jobMaxTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => {
                    if (col === 'First Seen' || col === 'Last Updated') {
                        return `<td>${new Date(row[col]).toLocaleString()}</td>`;
                    }
                    return `<td>${row[col] || ''}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        async function clearAllState() {
            if (!confirm('Are you sure you want to clear all tracked maximum resource values? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/clear_state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'all' })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('All state cleared successfully!');
                    refreshData();
                } else {
                    alert('Error clearing state: ' + result.message);
                }
            } catch (error) {
                console.error('Error clearing state:', error);
                alert('Error clearing state');
            }
        }

        function downloadCSV(dataType) {
            const sparkUrl = document.getElementById('sparkUrl').value;
            const yarnUrl = document.getElementById('yarnUrl').value;

            const url = `/download/${dataType}?spark_url=${encodeURIComponent(sparkUrl)}&yarn_url=${encodeURIComponent(yarnUrl)}`;

            const link = document.createElement('a');
            link.href = url;
            link.download = `${dataType}_jobs.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
