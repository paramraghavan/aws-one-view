<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Job Monitor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        .status-error { background-color: #fff3cd; color: #856404; }
        .status-running { background-color: #cce7ff; color: #004085; }

        .metric-card {
            transition: transform 0.2s;
            border-left: 4px solid transparent;
            height: 100%;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .metric-card.bg-primary { border-left-color: #0d6efd; }
        .metric-card.bg-info { border-left-color: #0dcaf0; }
        .metric-card.bg-success { border-left-color: #198754; }
        .metric-card.bg-warning { border-left-color: #ffc107; }
        .metric-card.bg-danger { border-left-color: #dc3545; }

        .metric-card .card-body {
            text-align: center;
            padding: 1.25rem;
        }

        /* Tooltip styling */
        .tooltip-trigger {
            cursor: help;
            border-bottom: 1px dotted rgba(255,255,255,0.7);
        }

        .custom-tooltip {
            position: relative;
            display: inline-block;
        }

        .custom-tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .custom-tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .custom-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .environment-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .cluster-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }

        .loading { display: none; }
        .loading.show { display: block; }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .table th {
            background-color: #343a40;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .progress-sm {
            height: 8px;
        }

        .badge-priority {
            font-size: 0.75em;
        }

        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Alert Banner -->
    <div class="alert alert-info alert-dismissible alert-banner" id="alertBanner">
        <div class="container-fluid">
            <span id="alertMessage"></span>
            <button type="button" class="btn-close" onclick="hideAlert()"></button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mt-3 mb-4">
                    <i class="fas fa-server text-primary"></i> EMR Job Monitor
                </h1>

                <!-- Environment Selection -->
                <div class="environment-selector">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="environmentSelect" class="form-label fw-bold">
                                <i class="fas fa-cloud"></i> EMR Environment
                            </label>
                            <select class="form-select" id="environmentSelect" onchange="environmentChanged()">
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="cluster-status">
                                <span class="status-indicator status-healthy" id="clusterStatusIndicator"></span>
                                <span id="clusterStatusText">Checking status...</span>
                            </div>
                            <small class="text-light opacity-75" id="environmentDescription">Select environment</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light me-2" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" id="autoRefresh">
                                <label class="form-check-label text-light" for="autoRefresh">Auto-refresh</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cluster Overview -->
                <div class="row mb-4" id="clusterOverview">
                    <div class="col-md-3">
                        <div class="card metric-card bg-primary text-white">
                            <div class="card-body">
                                <i class="fas fa-play-circle fa-2x mb-2"></i>
                                <div class="custom-tooltip">
                                    <h6 class="tooltip-trigger">Running Jobs</h6>
                                    <span class="tooltiptext">
                                        <strong>Running Jobs:</strong> Number of Spark applications currently executing on the cluster.
                                        These are jobs that have been submitted and are actively processing data using cluster resources.
                                    </span>
                                </div>
                                <h3 id="totalRunningJobs">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card bg-success text-white">
                            <div class="card-body">
                                <i class="fas fa-memory fa-2x mb-2"></i>
                                <div class="custom-tooltip">
                                    <h6 class="tooltip-trigger">Memory Usage</h6>
                                    <span class="tooltiptext">
                                        <strong>Memory Usage:</strong> Percentage of cluster memory currently allocated to running jobs.
                                        Shows how much of your total available RAM is being used. High values (>85%) may indicate resource constraints.
                                    </span>
                                </div>
                                <h3 id="memoryUtilization">0%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card bg-warning text-white">
                            <div class="card-body">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <div class="custom-tooltip">
                                    <h6 class="tooltip-trigger">Failed Jobs (24h)</h6>
                                    <span class="tooltiptext">
                                        <strong>Failed Jobs (24h):</strong> Number of jobs that failed to complete successfully in the last 24 hours.
                                        Failed jobs can indicate code issues, resource problems, or data quality issues.
                                    </span>
                                </div>
                                <h3 id="failedJobs24h">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card bg-danger text-white">
                            <div class="card-body">
                                <i class="fas fa-percentage fa-2x mb-2"></i>
                                <div class="custom-tooltip">
                                    <h6 class="tooltip-trigger">Success Rate</h6>
                                    <span class="tooltiptext">
                                        <strong>Success Rate:</strong> Percentage of jobs that completed successfully.
                                        Calculated as (successful jobs / total jobs) Ã— 100. A healthy cluster typically shows >95% success rate.
                                    </span>
                                </div>
                                <h3 id="successRate">0%</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading job data...</p>
                </div>

                <!-- Simplified Tabs -->
                <ul class="nav nav-tabs" id="jobTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="running-tab" data-bs-toggle="tab" data-bs-target="#running"
                                type="button" role="tab">
                            <i class="fas fa-play-circle"></i> Running Jobs
                            <span class="badge bg-primary ms-2" id="runningJobsBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed"
                                type="button" role="tab">
                            <i class="fas fa-check-circle"></i> Job History
                            <span class="badge bg-success ms-2" id="completedJobsBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary"
                                type="button" role="tab">
                            <i class="fas fa-chart-pie"></i> Job Summary
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="jobTabsContent">
                    <!-- Running Jobs Tab -->
                    <div class="tab-pane fade show active" id="running" role="tabpanel">
                        <div class="mt-3">
                            <!-- Key Metrics for Running Jobs -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card metric-card bg-info text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-memory"></i> Total Memory</h6>
                                                <span class="tooltiptext">
                                                    <strong>Total Memory:</strong> Sum of memory allocated to all currently running jobs in GB (Gigabytes).
                                                    This represents the total RAM being used across all active Spark applications on your cluster.
                                                </span>
                                            </div>
                                            <h4 id="runningMemory">0 GB</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-success text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-microchip"></i> Total vCores</h6>
                                                <span class="tooltiptext">
                                                    <strong>Total vCores:</strong> Sum of virtual CPU cores allocated to all running jobs.
                                                    vCores represent the processing power being used. Each vCore typically corresponds to one thread of execution.
                                                </span>
                                            </div>
                                            <h4 id="runningVCores">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-warning text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-clock"></i> Avg Progress</h6>
                                                <span class="tooltiptext">
                                                    <strong>Average Progress:</strong> Average completion percentage across all running jobs.
                                                    Calculated from each job's reported progress (0-100%). Helps estimate overall cluster workload completion.
                                                </span>
                                            </div>
                                            <h4 id="avgProgress">0%</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-danger text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-flag"></i> High Priority</h6>
                                                <span class="tooltiptext">
                                                    <strong>High Priority Jobs:</strong> Number of jobs using significant resources (>50GB memory or >20 vCores).
                                                    These jobs may impact cluster performance and should be monitored closely for optimization opportunities.
                                                </span>
                                            </div>
                                            <h4 id="highPriorityJobs">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Simple Filters -->
                            <div class="filter-section">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Filter by User</label>
                                        <select class="form-select" id="runningUserFilter">
                                            <option value="">All Users</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Min Memory (GB)</label>
                                        <input type="number" class="form-control" id="runningMemoryFilter"
                                               min="0" step="1" value="0" placeholder="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Sort By</label>
                                        <select class="form-select" id="runningSortBy">
                                            <option value="Submit Time">Submit Time</option>
                                            <option value="Memory (GB)">Memory Usage</option>
                                            <option value="Elapsed Time (mins)">Runtime</option>
                                            <option value="Progress (%)">Progress</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" onclick="applyRunningFilters()">
                                                <i class="fas fa-filter"></i> Apply
                                            </button>
                                            <button class="btn btn-outline-success" onclick="downloadCSV('running')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Running Jobs Table -->
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="runningJobsTable">
                                    <thead class="table-dark sticky-top">
                                        <tr id="runningTableHeader"></tr>
                                    </thead>
                                    <tbody id="runningTableBody"></tbody>
                                </table>
                            </div>
                            <div class="no-data" id="runningNoData" style="display: none;">
                                <i class="fas fa-coffee fa-3x mb-3 text-muted"></i>
                                <h4>No jobs running</h4>
                                <p class="text-muted">All quiet on the cluster!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Job History Tab -->
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        <div class="mt-3">
                            <!-- Key Metrics for Completed Jobs -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card metric-card bg-primary text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-check-circle"></i> Completed</h6>
                                                <span class="tooltiptext">
                                                    <strong>Completed Jobs:</strong> Total number of jobs that have finished execution (both successful and failed).
                                                    This count includes all jobs from the selected time range, providing insight into cluster activity levels.
                                                </span>
                                            </div>
                                            <h4 id="completedJobsCount">0</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-info text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-clock"></i> Avg Duration</h6>
                                                <span class="tooltiptext">
                                                    <strong>Average Duration:</strong> Mean execution time for completed jobs in minutes.
                                                    Helps identify if jobs are taking longer than expected and can indicate performance issues or optimization opportunities.
                                                </span>
                                            </div>
                                            <h4 id="avgDuration">0 min</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-success text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-percentage"></i> Success Rate</h6>
                                                <span class="tooltiptext">
                                                    <strong>Success Rate:</strong> Percentage of completed jobs that finished successfully without errors.
                                                    A healthy cluster should maintain >95% success rate. Lower rates may indicate code, data, or infrastructure issues.
                                                </span>
                                            </div>
                                            <h4 id="completedSuccessRate">0%</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card metric-card bg-warning text-white">
                                        <div class="card-body">
                                            <div class="custom-tooltip">
                                                <h6 class="tooltip-trigger"><i class="fas fa-dollar-sign"></i> Total Cost</h6>
                                                <span class="tooltiptext">
                                                    <strong>Total Cost:</strong> Estimated total cost for all completed jobs based on resource usage.
                                                    Calculated using memory-hours and vCore-hours consumed. Helps track spending and identify cost optimization opportunities.
                                                </span>
                                            </div>
                                            <h4 id="totalCost">$0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Simple Filters -->
                            <div class="filter-section">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Filter by User</label>
                                        <select class="form-select" id="completedUserFilter">
                                            <option value="">All Users</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="completedStatusFilter">
                                            <option value="">All Status</option>
                                            <option value="COMPLETED">Completed</option>
                                            <option value="FAILED">Failed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Last N Hours</label>
                                        <select class="form-select" id="completedHoursFilter">
                                            <option value="24">Last 24 hours</option>
                                            <option value="48">Last 48 hours</option>
                                            <option value="168">Last week</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" onclick="applyCompletedFilters()">
                                                <i class="fas fa-filter"></i> Apply
                                            </button>
                                            <button class="btn btn-outline-success" onclick="downloadCSV('completed')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Completed Jobs Table -->
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="completedJobsTable">
                                    <thead class="table-dark sticky-top">
                                        <tr id="completedTableHeader"></tr>
                                    </thead>
                                    <tbody id="completedTableBody"></tbody>
                                </table>
                            </div>
                            <div class="no-data" id="completedNoData" style="display: none;">
                                <i class="fas fa-history fa-3x mb-3 text-muted"></i>
                                <h4>No completed jobs found</h4>
                                <p class="text-muted">No jobs match the current criteria</p>
                            </div>
                        </div>
                    </div>

                    <!-- Job Summary Tab -->
                    <div class="tab-pane fade" id="summary" role="tabpanel">
                        <div class="mt-3">
                            <!-- Simple Summary Info -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Job Summary:</strong> View aggregated statistics by job name to identify resource usage patterns and optimization opportunities.
                                    </div>
                                </div>
                            </div>

                            <!-- Simple Filters -->
                            <div class="filter-section">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Min Runs</label>
                                        <select class="form-select" id="summaryMinRuns">
                                            <option value="1">1 or more runs</option>
                                            <option value="5">5 or more runs</option>
                                            <option value="10">10 or more runs</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Sort By</label>
                                        <select class="form-select" id="summarySortBy">
                                            <option value="Total Runs">Number of Runs</option>
                                            <option value="Total Memory-Hours">Total Memory Usage</option>
                                            <option value="Total Cost">Total Cost</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary flex-fill" onclick="applySummaryFilters()">
                                                <i class="fas fa-filter"></i> Apply
                                            </button>
                                            <button class="btn btn-outline-success" onclick="downloadCSV('summary')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Summary Table -->
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="summaryTable">
                                    <thead class="table-dark sticky-top">
                                        <tr id="summaryTableHeader"></tr>
                                    </thead>
                                    <tbody id="summaryTableBody"></tbody>
                                </table>
                            </div>
                            <div class="no-data" id="summaryNoData" style="display: none;">
                                <i class="fas fa-chart-pie fa-3x mb-3 text-muted"></i>
                                <h4>No summary data available</h4>
                                <p class="text-muted">No jobs match the summary criteria</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let jobData = {
            running: [],
            completed: [],
            summary: []
        };

        let environments = {};
        let currentEnvironment = '';
        let autoRefreshInterval;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadEnvironments();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Auto-refresh functionality
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000);
                    showAlert('Auto-refresh enabled (30 seconds)', 'success');
                } else {
                    clearInterval(autoRefreshInterval);
                    showAlert('Auto-refresh disabled', 'info');
                }
            });
        }

        function loadEnvironments() {
            fetch('/api/environments')
                .then(response => response.json())
                .then(data => {
                    environments = data;
                    populateEnvironmentSelect();
                })
                .catch(error => {
                    console.error('Error loading environments:', error);
                    showAlert('Failed to load environments', 'danger');
                });
        }

        function populateEnvironmentSelect() {
            const select = document.getElementById('environmentSelect');
            select.innerHTML = '<option value="">Select Environment...</option>';

            Object.keys(environments).forEach(key => {
                const env = environments[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = env.name;
                select.appendChild(option);
            });

            // Set default environment
            const defaultEnv = Object.keys(environments)[0];
            if (defaultEnv) {
                select.value = defaultEnv;
                environmentChanged();
            }
        }

        function environmentChanged() {
            const select = document.getElementById('environmentSelect');
            currentEnvironment = select.value;

            if (currentEnvironment && environments[currentEnvironment]) {
                const env = environments[currentEnvironment];
                document.getElementById('environmentDescription').textContent = env.description;
                updateClusterStatus();
                refreshData();
            }
        }

        function updateClusterStatus() {
            const indicator = document.getElementById('clusterStatusIndicator');
            const text = document.getElementById('clusterStatusText');

            fetch(`/api/cluster-metrics?environment=${currentEnvironment}`)
                .then(response => response.json())
                .then(data => {
                    const utilization = data.utilization_trends || {};
                    const failures = data.failure_analysis || {};

                    // Simple health determination
                    let status = 'healthy';
                    let statusText = 'Healthy';

                    if (utilization.memory_utilization_pct > 85) {
                        status = 'warning';
                        statusText = 'High Usage';
                    }

                    if (failures.failure_rate > 15) {
                        status = 'critical';
                        statusText = 'Issues Detected';
                    }

                    indicator.className = `status-indicator status-${status}`;
                    text.textContent = statusText;

                    // Update overview cards
                    updateOverviewCards(utilization, failures);
                })
                .catch(error => {
                    console.error('Error checking cluster status:', error);
                    indicator.className = 'status-indicator status-critical';
                    text.textContent = 'Unknown';
                });
        }

        function updateOverviewCards(utilization, failures) {
            document.getElementById('memoryUtilization').textContent = (utilization.memory_utilization_pct || 0) + '%';
            document.getElementById('failedJobs24h').textContent = failures.failed_jobs_24h || 0;
            document.getElementById('successRate').textContent = (100 - (failures.failure_rate || 0)).toFixed(0) + '%';
        }

        function showLoading() {
            document.querySelector('.loading').classList.add('show');
        }

        function hideLoading() {
            document.querySelector('.loading').classList.remove('show');
        }

        function showAlert(message, type = 'info') {
            const alertBanner = document.getElementById('alertBanner');
            const alertMessage = document.getElementById('alertMessage');

            alertBanner.className = `alert alert-${type} alert-dismissible alert-banner`;
            alertMessage.textContent = message;
            alertBanner.style.display = 'block';

            setTimeout(() => hideAlert(), 4000);
        }

        function hideAlert() {
            document.getElementById('alertBanner').style.display = 'none';
        }

        async function refreshData() {
            if (!currentEnvironment) {
                showAlert('Please select an environment', 'warning');
                return;
            }

            showLoading();

            try {
                await Promise.all([
                    loadRunningJobs(),
                    loadCompletedJobs(),
                    loadJobSummary()
                ]);

                showAlert('Data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showAlert('Error loading data', 'danger');
            } finally {
                hideLoading();
            }
        }

        async function loadRunningJobs() {
            const response = await fetch(`/api/running-jobs?environment=${currentEnvironment}`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            jobData.running = data.data || [];
            updateRunningSummary(data.summary || {});
            updateRunningTable(data.data || [], data.columns || []);
            populateRunningFilters(data.data || []);

            // Update badges and overview
            document.getElementById('runningJobsBadge').textContent = data.data ? data.data.length : 0;
            document.getElementById('totalRunningJobs').textContent = data.data ? data.data.length : 0;
        }

        async function loadCompletedJobs() {
            const response = await fetch(`/api/completed-jobs?environment=${currentEnvironment}`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            jobData.completed = data.data || [];
            updateCompletedSummary(data.summary || {});
            updateCompletedTable(data.data || [], data.columns || []);
            populateCompletedFilters(data.data || []);

            document.getElementById('completedJobsBadge').textContent = data.data ? data.data.length : 0;
        }

        async function loadJobSummary() {
            const response = await fetch(`/api/job-summary?environment=${currentEnvironment}`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            jobData.summary = data.data || [];
            updateSummaryTable(data.data || [], data.columns || []);
        }

        function updateRunningSummary(summary) {
            document.getElementById('runningMemory').textContent = (summary.total_memory || 0) + ' GB';
            document.getElementById('runningVCores').textContent = summary.total_vcores || 0;
            document.getElementById('avgProgress').textContent = (summary.avg_progress || 0) + '%';
            document.getElementById('highPriorityJobs').textContent = summary.high_priority_jobs || 0;
        }

        function updateCompletedSummary(summary) {
            document.getElementById('completedJobsCount').textContent = summary.total_jobs || 0;
            document.getElementById('completedSuccessRate').textContent = (summary.success_rate || 0) + '%';
            document.getElementById('totalCost').textContent = summary.total_estimated_cost || '$0.00';

            // Calculate average duration
            if (jobData.completed.length > 0) {
                const avgDur = jobData.completed.reduce((sum, job) =>
                    sum + (parseFloat(job['Duration (mins)']) || 0), 0) / jobData.completed.length;
                document.getElementById('avgDuration').textContent = Math.round(avgDur) + ' min';
            }
        }

        function updateRunningTable(data, columns) {
            updateTable('running', data, columns, formatRunningJobRow);
        }

        function updateCompletedTable(data, columns) {
            updateTable('completed', data, columns, formatCompletedJobRow);
        }

        function updateTable(tableType, data, columns, formatter) {
            const noDataDiv = document.getElementById(`${tableType}NoData`);
            const table = document.getElementById(`${tableType}JobsTable`);

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            // Update header
            const header = document.getElementById(`${tableType}TableHeader`);
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            // Update body
            const body = document.getElementById(`${tableType}TableBody`);
            body.innerHTML = data.map(row => formatter(row, columns)).join('');
        }

        function formatRunningJobRow(row, columns) {
            const cells = columns.map(col => {
                let value = row[col] || '';
                let cellClass = '';
                let cellContent = value;

                if (col === 'Status') {
                    cellClass = `status-${value.toLowerCase()}`;
                } else if (col === 'Priority') {
                    const priorityColors = {
                        'HIGH': 'danger',
                        'MEDIUM': 'warning',
                        'LOW': 'info'
                    };
                    const badgeColor = priorityColors[value] || 'secondary';
                    cellContent = `<span class="badge bg-${badgeColor} badge-priority">${value}</span>`;
                } else if (col === 'Progress (%)') {
                    const progress = parseFloat(value) || 0;
                    cellContent = `
                        <div class="progress progress-sm">
                            <div class="progress-bar" style="width: ${progress}%">${progress}%</div>
                        </div>
                    `;
                } else if (col === 'Memory (GB)' || col === 'vCores') {
                    cellContent = `<strong>${value}</strong>`;
                } else if (col === 'Elapsed Time (mins)') {
                    const mins = parseFloat(value) || 0;
                    if (mins > 60) {
                        const hours = Math.floor(mins / 60);
                        const remainingMins = Math.round(mins % 60);
                        cellContent = `${hours}h ${remainingMins}m`;
                    } else {
                        cellContent = `${Math.round(mins)}m`;
                    }
                }

                return `<td class="${cellClass}">${cellContent}</td>`;
            }).join('');
            return `<tr>${cells}</tr>`;
        }

        function formatCompletedJobRow(row, columns) {
            const cells = columns.map(col => {
                let value = row[col] || '';
                let cellClass = '';
                let cellContent = value;

                if (col === 'Status') {
                    cellClass = `status-${value.toLowerCase()}`;
                    const statusIcons = {
                        'COMPLETED': 'fas fa-check-circle text-success',
                        'FAILED': 'fas fa-times-circle text-danger',
                        'ERROR': 'fas fa-exclamation-triangle text-warning'
                    };
                    const icon = statusIcons[value] || '';
                    cellContent = `<i class="${icon}"></i> ${value}`;
                } else if (col === 'Duration (mins)') {
                    const mins = parseFloat(value) || 0;
                    if (mins > 60) {
                        const hours = Math.floor(mins / 60);
                        const remainingMins = Math.round(mins % 60);
                        cellContent = `${hours}h ${remainingMins}m`;
                    } else {
                        cellContent = `${Math.round(mins)}m`;
                    }
                } else if (col === 'Memory (GB)' || col === 'vCores') {
                    cellContent = `<strong>${value}</strong>`;
                } else if (col === 'Cost Estimate') {
                    cellContent = `<span class="badge bg-dark">${value}</span>`;
                } else if (col === 'Efficiency Score') {
                    const score = parseFloat(value) || 0;
                    let badgeColor = 'danger';
                    if (score >= 70) badgeColor = 'success';
                    else if (score >= 40) badgeColor = 'warning';
                    cellContent = `<span class="badge bg-${badgeColor}">${score}</span>`;
                }

                return `<td class="${cellClass}">${cellContent}</td>`;
            }).join('');
            return `<tr>${cells}</tr>`;
        }

        function updateSummaryTable(data, columns) {
            const noDataDiv = document.getElementById('summaryNoData');
            const table = document.getElementById('summaryTable');

            if (!data || data.length === 0) {
                noDataDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }

            noDataDiv.style.display = 'none';
            table.style.display = 'table';

            // Update header
            const header = document.getElementById('summaryTableHeader');
            header.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            // Update body with simplified formatting
            const body = document.getElementById('summaryTableBody');
            body.innerHTML = data.map(row => {
                const cells = columns.map(col => {
                    let value = row[col] || '';
                    let cellContent = value;

                    if (col === 'Total Cost') {
                        cellContent = `<span class="badge bg-dark">${value}</span>`;
                    } else if (col === 'Job Name') {
                        cellContent = `<strong>${value}</strong>`;
                    } else if (col.includes('Total') && col.includes('GB')) {
                        cellContent = `<span class="text-info fw-bold">${value}</span>`;
                    } else if (col === 'Total Runs') {
                        cellContent = `<span class="badge bg-primary">${value}</span>`;
                    }

                    return `<td>${cellContent}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function populateRunningFilters(data) {
            populateSelectFilter('runningUserFilter', data, 'User');
        }

        function populateCompletedFilters(data) {
            populateSelectFilter('completedUserFilter', data, 'User');
        }

        function populateSelectFilter(selectId, data, column) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;

            // Get unique values
            const uniqueValues = [...new Set(data.map(row => row[column]).filter(val => val && val !== 'Unknown'))].sort();

            // Clear and repopulate
            const allOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (allOption) {
                select.appendChild(allOption);
            } else {
                select.innerHTML = '<option value="">All</option>';
            }

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            // Restore previous selection
            if (currentValue && uniqueValues.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function applyRunningFilters() {
            loadRunningJobs();
        }

        function applyCompletedFilters() {
            loadCompletedJobs();
        }

        function applySummaryFilters() {
            loadJobSummary();
        }

        function downloadCSV(dataType) {
            if (!currentEnvironment) {
                showAlert('Please select an environment first', 'warning');
                return;
            }

            const url = `/download/${dataType}?environment=${currentEnvironment}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `${dataType}_jobs_${currentEnvironment}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert(`Downloading ${dataType} jobs data...`, 'info');
        }
    </script>
</body>
</html>