<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Rerun Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .status-success {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .profile-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .profile-configured {
            color: #28a745;
            font-weight: bold;
        }
        .profile-not-configured {
            color: #dc3545;
            font-weight: bold;
        }
        .profile-warning {
            color: #ffc107;
            font-weight: bold;
        }
        .copy-confirmation {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Data Ingestion Job Rerun Tool</h1>

        <div class="alert alert-info">
            <strong>Configuration:</strong> AWS profiles and buckets are configured in <code>env_config.py</code> |
            Entity mappings and cleanup hooks are in <code>entity_config.json</code>
        </div>

        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="parse-tab" data-bs-toggle="tab" data-bs-target="#parse" type="button">1. Parse Source</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button">2. Query, Filter & Copy</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Parse Source Tab -->
            <div class="tab-pane fade show active" id="parse" role="tabpanel">
                <h3>Parse Source Bucket</h3>
                <form id="parseForm">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">AWS Profile</label>
                            <select class="form-select" id="parseProfile" required onchange="updateParseProfileInfo()">
                                <option value="">Select Profile...</option>
                            </select>
                            <div id="parseProfileInfo" class="profile-info mt-2" style="display:none;">
                                <div><strong>Source Bucket:</strong> <span id="parseSourceBucketInfo"></span></div>
                                <div><strong>Destination Bucket:</strong> <span id="parseDestBucketInfo"></span></div>
                                <div><strong>Status:</strong> <span id="parseProfileStatus"></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Date/Time (Optional)</label>
                            <input type="datetime-local" class="form-control" id="parseStartDate">
                            <small class="text-muted">Leave empty to include all data from beginning</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date/Time (Optional)</label>
                            <input type="datetime-local" class="form-control" id="parseEndDate">
                            <small class="text-muted">Leave empty to include all data to present</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useExistingPickle">
                            <label class="form-check-label" for="useExistingPickle">
                                Use Existing Pickle File (skip S3 parsing)
                            </label>
                        </div>
                        <select class="form-select mt-2" id="existingPickleFile" style="display:none;">
                            <option value="">Select Pickle File...</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Parse Source Bucket</button>
                </form>

                <div id="parseResults" class="mt-4"></div>
            </div>

            <!-- Query, Filter & Copy Tab -->
            <div class="tab-pane fade" id="query" role="tabpanel">
                <h3>Query, Filter & Copy to Staging</h3>

                <!-- Step 1: Select Profile -->
                <div class="card mb-3">
                    <div class="card-header"><strong>Step 1:</strong> Select AWS Profile</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">AWS Profile</label>
                                <select class="form-select" id="queryProfile" onchange="updateQueryProfileInfo()">
                                    <option value="">Select Profile...</option>
                                </select>
                                <div id="queryProfileInfo" class="profile-info mt-2" style="display:none;">
                                    <div><strong>Source Bucket:</strong> <span id="querySourceBucketInfo"></span></div>
                                    <div><strong>Destination Bucket:</strong> <span id="queryDestBucketInfo"></span></div>
                                    <div><strong>Status:</strong> <span id="queryProfileStatus"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select and Filter Data -->
                <div class="card mb-3">
                    <div class="card-header"><strong>Step 2:</strong> Select Pickle File and Apply Filters</div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Select Pickle File</label>
                                <select class="form-select" id="queryPickleFile">
                                    <option value="">Select Pickle File...</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Entity Name</label>
                                <input type="text" class="form-control" id="filterEntity" placeholder="e.g., FHL">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Dataset</label>
                                <input type="text" class="form-control" id="filterDataset" placeholder="e.g., Dataset134">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="filterStartDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="filterEndDate">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="queryPickleFile()">Apply Filters</button>
                        <button class="btn btn-secondary ms-2" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>

                <!-- Step 3: Review and Select -->
                <div class="card mb-3">
                    <div class="card-header"><strong>Step 3:</strong> Review and Select Files</div>
                    <div class="card-body">
                        <div id="queryResults">
                            <div class="table-container">
                                <table class="table table-striped table-hover" id="queryResultsTable" style="display:none;">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                            <th>Entity</th>
                                            <th>Dataset</th>
                                            <th>Year</th>
                                            <th>Month</th>
                                            <th>Day</th>
                                            <th>Filename</th>
                                        </tr>
                                    </thead>
                                    <tbody id="queryResultsBody"></tbody>
                                </table>
                            </div>
                            <div class="alert alert-info mt-3" id="selectionInfo" style="display:none;">
                                <strong>Selected:</strong> <span id="selectedCount">0</span> file(s)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Confirm and Copy -->
                <div class="card mb-3" id="copyConfirmationCard" style="display:none;">
                    <div class="card-header bg-warning"><strong>Step 4:</strong> Confirm and Copy to Staging</div>
                    <div class="card-body">
                        <div class="copy-confirmation">
                            <h5>⚠️ Ready to Copy Files</h5>
                            <p>You are about to copy <strong id="confirmFileCount">0</strong> file(s) to staging.</p>
                            <div class="mb-2">
                                <strong>From:</strong> <span id="confirmSourceBucket"></span><br>
                                <strong>To:</strong> <span id="confirmDestBucket"></span>
                            </div>
                            <p class="mb-0"><small>Note: Cleanup hooks will be executed before copying each file.</small></p>
                        </div>
                        <button class="btn btn-success btn-lg" onclick="executeStaging()">
                            ✓ Confirm and Copy to Staging
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="cancelStaging()">Cancel</button>
                    </div>
                </div>

                <!-- Copy Results -->
                <div id="copyResults" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = [];
        let selectedRecords = [];
        let profilesData = {};
        let currentProfile = null;

        // Load profiles and pickle files on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
            loadPickleFiles();
        });

        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const data = await response.json();

                if (data.error) {
                    alert('Error loading profiles: ' + data.error);
                    return;
                }

                profilesData = {};
                data.profiles.forEach(profile => {
                    profilesData[profile.name] = profile;
                });

                const profileSelects = ['parseProfile', 'queryProfile'];
                profileSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select Profile...</option>';

                    data.profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.name;

                        // Add status indicator
                        let status = '';
                        if (profile.fully_configured) {
                            status = '✓ ';
                        } else if (profile.aws_configured && !profile.buckets_configured) {
                            status = '⚠ ';
                        } else if (!profile.aws_configured && profile.buckets_configured) {
                            status = '⚠ ';
                        } else {
                            status = '✗ ';
                        }

                        option.textContent = `${status}${profile.name}${profile.description ? ' - ' + profile.description : ''}`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading profiles:', error);
                alert('Failed to load profiles. Check console for details.');
            }
        }

        function updateParseProfileInfo() {
            const profileName = document.getElementById('parseProfile').value;
            if (!profileName || !profilesData[profileName]) {
                document.getElementById('parseProfileInfo').style.display = 'none';
                return;
            }

            const profile = profilesData[profileName];
            document.getElementById('parseSourceBucketInfo').textContent = profile.source_bucket || 'Not configured';
            document.getElementById('parseDestBucketInfo').textContent = profile.destination_bucket || 'Not configured';

            const statusSpan = document.getElementById('parseProfileStatus');
            if (profile.fully_configured) {
                statusSpan.innerHTML = '<span class="profile-configured">✓ Fully Configured</span>';
            } else if (!profile.aws_configured) {
                statusSpan.innerHTML = '<span class="profile-not-configured">✗ AWS credentials not found in ~/.aws/credentials</span>';
            } else if (!profile.buckets_configured) {
                statusSpan.innerHTML = '<span class="profile-not-configured">✗ Buckets not configured in env_config.py</span>';
            } else {
                statusSpan.innerHTML = '<span class="profile-warning">⚠ Partially configured</span>';
            }

            document.getElementById('parseProfileInfo').style.display = 'block';
        }

        function updateQueryProfileInfo() {
            const profileName = document.getElementById('queryProfile').value;
            currentProfile = profileName;

            if (!profileName || !profilesData[profileName]) {
                document.getElementById('queryProfileInfo').style.display = 'none';
                document.getElementById('copyConfirmationCard').style.display = 'none';
                return;
            }

            const profile = profilesData[profileName];
            document.getElementById('querySourceBucketInfo').textContent = profile.source_bucket || 'Not configured';
            document.getElementById('queryDestBucketInfo').textContent = profile.destination_bucket || 'Not configured';

            const statusSpan = document.getElementById('queryProfileStatus');
            if (profile.fully_configured) {
                statusSpan.innerHTML = '<span class="profile-configured">✓ Fully Configured</span>';
            } else if (!profile.aws_configured) {
                statusSpan.innerHTML = '<span class="profile-not-configured">✗ AWS credentials not found in ~/.aws/credentials</span>';
            } else if (!profile.buckets_configured) {
                statusSpan.innerHTML = '<span class="profile-not-configured">✗ Buckets not configured in env_config.py</span>';
            } else {
                statusSpan.innerHTML = '<span class="profile-warning">⚠ Partially configured</span>';
            }

            document.getElementById('queryProfileInfo').style.display = 'block';
        }

        async function loadPickleFiles() {
            try {
                const response = await fetch('/api/pickle_files');
                const data = await response.json();

                const pickleSelects = ['existingPickleFile', 'queryPickleFile'];
                pickleSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select Pickle File...</option>';
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading pickle files:', error);
            }
        }

        document.getElementById('useExistingPickle').addEventListener('change', function(e) {
            document.getElementById('existingPickleFile').style.display =
                e.target.checked ? 'block' : 'none';
        });

        document.getElementById('parseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const profileName = document.getElementById('parseProfile').value;
            if (!profileName) {
                alert('Please select an AWS profile');
                return;
            }

            const profile = profilesData[profileName];
            if (!profile.fully_configured) {
                let msg = 'Selected profile is not fully configured:\n';
                if (!profile.aws_configured) {
                    msg += '- AWS credentials not found in ~/.aws/credentials\n';
                }
                if (!profile.buckets_configured) {
                    msg += '- Buckets not configured in env_config.py\n';
                }
                alert(msg);
                return;
            }

            const useExisting = document.getElementById('useExistingPickle').checked;

            if (useExisting) {
                const pickleFile = document.getElementById('existingPickleFile').value;
                if (!pickleFile) {
                    alert('Please select a pickle file');
                    return;
                }

                try {
                    const response = await fetch('/api/load_pickle', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({pickle_file: pickleFile})
                    });

                    const result = await response.json();
                    displayParseResults(result);
                } catch (error) {
                    alert('Error loading pickle file: ' + error.message);
                }
            } else {
                const data = {
                    profile: profileName,
                    start_date: document.getElementById('parseStartDate').value || null,
                    end_date: document.getElementById('parseEndDate').value || null
                };

                try {
                    document.getElementById('parseResults').innerHTML =
                        '<div class="alert alert-info">Parsing source bucket...</div>';

                    const response = await fetch('/api/parse_source', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    displayParseResults(result);
                    loadPickleFiles();
                } catch (error) {
                    document.getElementById('parseResults').innerHTML =
                        `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            }
        });

        function displayParseResults(result) {
            if (result.error) {
                document.getElementById('parseResults').innerHTML =
                    `<div class="alert alert-danger">Error: ${result.error}</div>`;
                return;
            }

            let html = `
                <div class="alert alert-success">
                    <strong>Success!</strong> Found ${result.record_count} records
                    ${result.pickle_file ? `<br>Saved to: ${result.pickle_file}` : ''}
                    ${result.source_bucket ? `<br>Source: ${result.source_bucket}` : ''}
                </div>
            `;

            if (result.preview || result.data) {
                const data = result.preview || result.data.slice(0, 10);
                html += '<h5>Preview (first 10 records):</h5>';
                html += '<div class="table-container"><table class="table table-sm table-striped">';
                html += '<thead><tr><th>Entity</th><th>Dataset</th><th>Year</th><th>Month</th><th>Day</th><th>Filename</th></tr></thead><tbody>';

                data.forEach(row => {
                    html += `<tr>
                        <td>${row.entity_name}</td>
                        <td>${row.dataset}</td>
                        <td>${row.year}</td>
                        <td>${row.month}</td>
                        <td>${row.day}</td>
                        <td>${row.filename}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            document.getElementById('parseResults').innerHTML = html;
        }

        async function queryPickleFile() {
            const pickleFile = document.getElementById('queryPickleFile').value;
            if (!pickleFile) {
                alert('Please select a pickle file');
                return;
            }

            const filters = {
                entity_name: document.getElementById('filterEntity').value || null,
                dataset: document.getElementById('filterDataset').value || null,
                start_date: document.getElementById('filterStartDate').value || null,
                end_date: document.getElementById('filterEndDate').value || null
            };

            try {
                const response = await fetch('/api/query_pickle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pickle_file: pickleFile, filters: filters})
                });

                const result = await response.json();
                displayQueryResults(result);
            } catch (error) {
                alert('Error querying pickle file: ' + error.message);
            }
        }

        function displayQueryResults(result) {
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }

            currentData = result.data;
            const tbody = document.getElementById('queryResultsBody');
            tbody.innerHTML = '';

            result.data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                    <td>${row.entity_name}</td>
                    <td>${row.dataset}</td>
                    <td>${row.year}</td>
                    <td>${row.month}</td>
                    <td>${row.day}</td>
                    <td>${row.filename}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('queryResultsTable').style.display = 'table';
            document.getElementById('selectionInfo').style.display = 'block';

            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });

            updateSelectedCount();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            selectedRecords = [];
            document.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                selectedRecords.push(currentData[index]);
            });
            document.getElementById('selectedCount').textContent = selectedRecords.length;

            if (selectedRecords.length > 0 && currentProfile) {
                showCopyConfirmation();
            } else {
                document.getElementById('copyConfirmationCard').style.display = 'none';
            }
        }

        function showCopyConfirmation() {
            if (!currentProfile || !profilesData[currentProfile]) {
                alert('Please select an AWS profile first');
                return;
            }

            const profile = profilesData[currentProfile];
            if (!profile.fully_configured) {
                let msg = 'Selected profile is not fully configured:\n';
                if (!profile.aws_configured) {
                    msg += '- AWS credentials not found in ~/.aws/credentials\n';
                }
                if (!profile.buckets_configured) {
                    msg += '- Buckets not configured in env_config.py\n';
                }
                alert(msg);
                return;
            }

            document.getElementById('confirmFileCount').textContent = selectedRecords.length;
            document.getElementById('confirmSourceBucket').textContent = profile.source_bucket;
            document.getElementById('confirmDestBucket').textContent = profile.destination_bucket;
            document.getElementById('copyConfirmationCard').style.display = 'block';

            document.getElementById('copyConfirmationCard').scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }

        function cancelStaging() {
            document.getElementById('copyConfirmationCard').style.display = 'none';
        }

        async function executeStaging() {
            if (selectedRecords.length === 0) {
                alert('No records selected');
                return;
            }

            if (!currentProfile) {
                alert('Please select an AWS profile');
                return;
            }

            const data = {
                profile: currentProfile,
                records: selectedRecords
            };

            try {
                document.getElementById('copyResults').innerHTML =
                    '<div class="alert alert-info">Copying files to staging...</div>';

                document.getElementById('copyConfirmationCard').style.display = 'none';

                const response = await fetch('/api/copy_to_staging', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                displayCopyResults(result);
            } catch (error) {
                document.getElementById('copyResults').innerHTML =
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function displayCopyResults(result) {
            if (result.error) {
                document.getElementById('copyResults').innerHTML =
                    `<div class="alert alert-danger">Error: ${result.error}</div>`;
                return;
            }

            let html = '<div class="table-container"><table class="table table-striped"><thead><tr>';
            html += '<th>Filename</th><th>Status</th><th>Cleanup</th><th>Destination</th><th>Error</th>';
            html += '</tr></thead><tbody>';

            result.results.forEach(item => {
                const statusClass = item.success ? 'status-success' : 'status-error';
                html += `<tr>
                    <td>${item.filename}</td>
                    <td class="${statusClass}">${item.success ? '✓ Success' : '✗ Failed'}</td>
                    <td>${item.cleanup || '-'}</td>
                    <td>${item.destination || '-'}</td>
                    <td>${item.error || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            const successCount = result.results.filter(r => r.success).length;
            const totalCount = result.results.length;

            html = `<div class="alert alert-${successCount === totalCount ? 'success' : 'warning'}">
                <strong>Completed:</strong> ${successCount}/${totalCount} files copied successfully<br>
                <strong>Source:</strong> ${result.source_bucket}<br>
                <strong>Destination:</strong> ${result.destination_bucket}
            </div>` + html;

            document.getElementById('copyResults').innerHTML = html;
            document.getElementById('copyResults').scrollIntoView({ behavior: 'smooth' });
        }

        function clearFilters() {
            document.getElementById('filterEntity').value = '';
            document.getElementById('filterDataset').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
        }
    </script>
</body>
</html>