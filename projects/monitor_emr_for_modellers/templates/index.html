async function viewLogs(appId) {
            try {
                updateRefreshStatus('Loading logs...');
                const response = await fetch(`/api/cluster/${currentCluster}/application/${appId}/logs`);

                if (response.ok) {
                    const data = await response.json();
                    displayLogsModal(appId, data.logs_data);
                    updateRefreshStatus('Logs loaded successfully');
                } else {
                    throw new Error('Failed to load logs');
                }
            } catch (error) {
                console.error('Failed to view logs:', error);
                showError('Failed to load logs: ' + error.message);
            }
        }

        function displayLogsModal(appId, logsData) {
            let logsHtml = `
                <div style="max-width: 90vw; max-height: 85vh; overflow: hidden; padding: 20px; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                        <h3 style="color: #2c3e50; margin: 0;">Application Logs: ${appId}</h3>
                        <button onclick="closeModal()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: auto;">Close</button>
                    </div>

                    <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">`;

            // Create tabs for different log types
            const logTypes = [];
            if (logsData.driver_logs) logTypes.push({key: 'driver', name: 'Driver Logs', content: logsData.driver_logs});
            if (logsData.executor_logs) {
                Object.entries(logsData.executor_logs).forEach(([key, content]) => {
                    if (content) logTypes.push({key: key, name: key.replace('_', ' ').toUpperCase(), content: content});
                });
            }
            if (logsData.container_logs) {
                Object.entries(logsData.container_logs).forEach(([key, content]) => {
                    if (content) logTypes.push({key: key, name: `Container ${key.slice(-12)}`, content: content});
                });
            }
            if (logsData.yarn_info) logTypes.push({key: 'yarn_info', name: 'YARN Info', content: JSON.stringify(logsData.yarn_info, null, 2), isJson: true});
            if (logsData.spark_jobs) logTypes.push({key: 'spark_jobs', name: 'Spark Jobs', content: JSON.stringify(logsData.spark_jobs, null, 2), isJson: true});
            if (logsData.environment) logTypes.push({key: 'environment', name: 'Environment', content: JSON.stringify(logsData.environment, null, 2), isJson: true});

            if (logTypes.length === 0) {
                logsHtml += `<p style="text-align: center; color: #7f8c8d; padding: 40px;">No logs available for this application</p>`;
            } else {
                // Tabs
                logsHtml += `<div style="display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; flex-shrink: 0;">`;
                logTypes.forEach((logType, index) => {
                    logsHtml += `<button onclick="showLogTab('${logType.key}')" id="tab-${logType.key}" style="padding: 8px 12px; border: 2px solid #e0e6ed; background: white; border-radius: 5px; cursor: pointer; font-size: 12px; ${index === 0 ? 'background: #667eea; color: white; border-color: #667eea;' : ''}">${logType.name}</button>`;
                });
                logsHtml += `</div>`;

                // Log content areas
                logTypes.forEach((logType, index) => {
                    const displayStyle = index === 0 ? 'block' : 'none';
                    const backgroundColor = logType.isJson ? '#f8f9fa' : '#000';
                    const textColor = logType.isJson ? '#333' : '#0f0';
                    const fontFamily = logType.isJson ? 'Consolas, Monaco, monospace' : 'Courier New, monospace';

                    logsHtml += `
                        <div id="log-${logType.key}" style="display: ${displayStyle}; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #2c3e50; font-size: 14px;">${logType.name}</h4>
                                <button onclick="downloadSingleLog('${appId}', '${logType.key}', '${logType.name}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Download</button>
                            </div>
                            <div style="flex: 1; overflow: auto; background: ${backgroundColor}; color: ${textColor}; padding: 15px; border-radius: 5px; font-family: ${fontFamily}; font-size: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;">
                                ${logType.content || 'No content available'}
                            </div>
                        </div>`;
                });
            }

            logsHtml += `
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-shrink: 0;">
                        <button onclick="downloadLogs('${appId}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Download All Logs</button>
                    </div>
                </div>`;

            showModal(logsHtml);

            // Store log data for single downloads
            window.currentLogsData = {};
            logTypes.forEach(logType => {
                window.currentLogsData[logType.key] = {name: logType.name, content: logType.content};
            });
        }

        function showLogTab(tabKey) {
            // Hide all log content areas
            document.querySelectorAll('[id^="log-"]').forEach(el => {
                el.style.display = 'none';
            });

            // Remove active style from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.style.background = 'white';
                el.style.color = '#333';
                el.style.borderColor = '#e0e6ed';
            });

            // Show selected log content
            document.getElementById(`log-${tabKey}`).style.display = 'flex';

            // Style active tab
            const activeTab = document.getElementById(`tab-${tabKey}`);
            activeTab.style.background = '#667eea';
            activeTab.style.color = 'white';
            activeTab.style.borderColor = '#667eea';
        }

        function downloadSingleLog(appId, logKey, logName) {
            if (!window.currentLogsData || !window.currentLogsData[logKey]) {
                showError('Log data not available');
                return;
            }

            const logData = window.currentLogsData[logKey];
            const content = logData.content;
            const filename = `${appId}_${logKey}.${logKey.includes('info') || logKey.includes('jobs') || logKey.includes('environment') ? 'json' : 'log'}`;

            // Create and trigger download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            updateRefreshStatus(`Downloaded ${filename}`);
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .cluster-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        select, button {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: 300;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-subtitle {
            font-size: 12px;
            color: #95a5a6;
        }

        .applications-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: 300;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 8px 16px;
            border: 2px solid #e0e6ed;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab:hover {
            border-color: #667eea;
        }

        .applications-grid {
            display: grid;
            gap: 20px;
        }

        .application-card {
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            background: white;
        }

        .application-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .app-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            flex-grow: 1;
        }

        .app-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-running { background: #e8f5e8; color: #27ae60; }
        .status-succeeded { background: #e3f2fd; color: #2196f3; }
        .status-failed { background: #ffebee; color: #f44336; }
        .status-accepted { background: #fff3e0; color: #ff9800; }
        .status-killed { background: #f3e5f5; color: #9c27b0; }

        .app-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .app-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            width: auto;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #e0e6ed;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .resource-bar {
            background: #e0e6ed;
            border-radius: 10px;
            height: 6px;
            margin-top: 5px;
            overflow: hidden;
        }

        .resource-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .refresh-status {
            color: #7f8c8d;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .filter-tabs {
                justify-content: center;
            }

            .app-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EMR Monitoring Dashboard</h1>
            <p>Monitor your EMR clusters, track resource usage, and manage Spark applications</p>
        </div>

        <div class="cluster-selector">
            <div class="form-group">
                <label for="clusterSelect">Select EMR Cluster:</label>
                <select id="clusterSelect">
                    <option value="">Choose a cluster...</option>
                </select>
            </div>
            <button onclick="loadClusterData()" id="loadButton" disabled>Load Cluster Data</button>

            <div class="auto-refresh" style="margin-top: 15px;">
                <label>
                    <input type="checkbox" id="autoRefresh"> Auto-refresh (30s)
                </label>
                <span class="refresh-status" id="refreshStatus"></span>
            </div>
        </div>

        <div id="clusterMetrics" class="metrics-grid" style="display: none;"></div>

        <div id="applicationsSection" class="applications-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Applications</h2>
                <div class="filter-tabs">
                    <div class="tab active" onclick="filterApplications('all')" data-filter="all">All</div>
                    <div class="tab" onclick="filterApplications('RUNNING')" data-filter="RUNNING">Running</div>
                    <div class="tab" onclick="filterApplications('FINISHED')" data-filter="FINISHED">Completed</div>
                    <div class="tab" onclick="filterApplications('FAILED')" data-filter="FAILED">Failed</div>
                    <div class="tab" onclick="filterApplications('ACCEPTED')" data-filter="ACCEPTED">Accepted</div>
                </div>
            </div>
            <div id="applicationsGrid" class="applications-grid"></div>
        </div>

        <div id="loadingState" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading cluster data...</p>
        </div>
    </div>

    <script>
        let currentCluster = null;
        let applicationsData = [];
        let currentFilter = 'all';
        let refreshInterval = null;

        // Load available clusters on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadClusters();
        });

        async function loadClusters() {
            try {
                const response = await fetch('/api/clusters');
                const clusters = await response.json();

                const select = document.getElementById('clusterSelect');
                select.innerHTML = '<option value="">Choose a cluster...</option>';

                for (const [key, cluster] of Object.entries(clusters)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${cluster.name} - ${cluster.description}`;
                    select.appendChild(option);
                }

                select.addEventListener('change', function() {
                    const loadButton = document.getElementById('loadButton');
                    loadButton.disabled = !this.value;
                    currentCluster = this.value;
                });

            } catch (error) {
                console.error('Failed to load clusters:', error);
                showError('Failed to load cluster configuration');
            }
        }

        async function loadClusterData() {
            if (!currentCluster) return;

            showLoading(true);

            try {
                const response = await fetch(`/api/cluster/${currentCluster}/applications`);
                const data = await response.json();

                applicationsData = data.spark_applications || [];

                displayClusterMetrics(data.cluster_metrics, data.cluster_info);
                displayApplications();

                document.getElementById('applicationsSection').style.display = 'block';
                updateRefreshStatus('Data loaded successfully');

            } catch (error) {
                console.error('Failed to load cluster data:', error);
                showError('Failed to load cluster data');
            } finally {
                showLoading(false);
            }
        }

        function displayClusterMetrics(metrics, info) {
            const metricsContainer = document.getElementById('clusterMetrics');

            if (!metrics || !metrics.clusterMetrics) {
                metricsContainer.style.display = 'none';
                return;
            }

            const clusterMetrics = metrics.clusterMetrics;

            const totalMem = clusterMetrics.totalMB || 0;
            const availableMem = clusterMetrics.availableMB || 0;
            const usedMem = totalMem - availableMem;

            const totalCores = clusterMetrics.totalVirtualCores || 0;
            const availableCores = clusterMetrics.availableVirtualCores || 0;
            const usedCores = totalCores - availableCores;

            const runningApps = clusterMetrics.appsRunning || 0;
            const totalApps = (clusterMetrics.appsCompleted || 0) + runningApps + (clusterMetrics.appsFailed || 0);

            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="metric-title">Memory Usage</div>
                    <div class="metric-value">${Math.round((usedMem / totalMem) * 100)}%</div>
                    <div class="metric-subtitle">${formatBytes(usedMem * 1024 * 1024)} / ${formatBytes(totalMem * 1024 * 1024)}</div>
                    <div class="resource-bar">
                        <div class="resource-fill" style="width: ${(usedMem / totalMem) * 100}%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">CPU Cores</div>
                    <div class="metric-value">${usedCores}</div>
                    <div class="metric-subtitle">${usedCores} used / ${totalCores} total</div>
                    <div class="resource-bar">
                        <div class="resource-fill" style="width: ${(usedCores / totalCores) * 100}%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Running Apps</div>
                    <div class="metric-value">${runningApps}</div>
                    <div class="metric-subtitle">Active applications</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Total Apps</div>
                    <div class="metric-value">${totalApps}</div>
                    <div class="metric-subtitle">All time applications</div>
                </div>
            `;

            metricsContainer.style.display = 'grid';
        }

        function displayApplications() {
            const filteredApps = currentFilter === 'all' ?
                applicationsData :
                applicationsData.filter(app => app.attempts && app.attempts[0] && app.attempts[0].completed === (currentFilter === 'FINISHED'));

            const container = document.getElementById('applicationsGrid');

            if (filteredApps.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No applications found</p>';
                return;
            }

            container.innerHTML = filteredApps.map(app => createApplicationCard(app)).join('');
        }

        function createApplicationCard(app) {
            const attempt = app.attempts && app.attempts[0];
            const status = attempt ? (attempt.completed ? 'FINISHED' : 'RUNNING') : 'UNKNOWN';
            const statusClass = `status-${status.toLowerCase()}`;

            const duration = attempt ?
                (attempt.duration ? formatDuration(attempt.duration) :
                 (new Date() - new Date(attempt.startTime)).toString()) : 'N/A';

            const memoryUsage = app.executors ?
                app.executors.reduce((sum, exec) => sum + (exec.memoryUsed || 0), 0) : 0;

            const cores = app.executors ?
                app.executors.reduce((sum, exec) => sum + (exec.totalCores || 0), 0) : 0;

            return `
                <div class="application-card" data-status="${status}">
                    <div class="app-header">
                        <div class="app-name">${app.name || app.id}</div>
                        <div class="app-status ${statusClass}">${status}</div>
                    </div>

                    <div class="app-details">
                        <div class="detail-item">
                            <div class="detail-label">Application ID</div>
                            <div class="detail-value">${app.id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duration</div>
                            <div class="detail-value">${duration}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Memory Used</div>
                            <div class="detail-value">${formatBytes(memoryUsage)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">CPU Cores</div>
                            <div class="detail-value">${cores}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Started</div>
                            <div class="detail-value">${attempt ? new Date(attempt.startTime).toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">User</div>
                            <div class="detail-value">${app.sparkUser || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="app-actions">
                        <button class="btn-small btn-primary" onclick="viewApplicationDetails('${app.id}')">
                            View Details
                        </button>
                        <button class="btn-small btn-secondary" onclick="viewLogs('${app.id}')">
                            View Logs
                        </button>
                        <button class="btn-small btn-secondary" onclick="downloadLogs('${app.id}')">
                            Download Logs
                        </button>
                        ${status === 'RUNNING' ?
                            `<button class="btn-small btn-danger" onclick="killApplication('${app.id}')">
                                Kill Application
                            </button>` : ''}
                    </div>
                </div>
            `;
        }

        function filterApplications(filter) {
            currentFilter = filter;

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });

            displayApplications();
        }

        async function viewApplicationDetails(appId) {
            try {
                const app = applicationsData.find(a => a.id === appId);
                if (!app) return;

                let detailsHtml = `
                    <div style="max-width: 800px; max-height: 80vh; overflow-y: auto; padding: 20px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Application Details: ${app.name || app.id}</h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div><strong>ID:</strong> ${app.id}</div>
                            <div><strong>Name:</strong> ${app.name || 'N/A'}</div>
                            <div><strong>User:</strong> ${app.sparkUser || 'N/A'}</div>
                            <div><strong>Spark Version:</strong> ${app.sparkVersion || 'N/A'}</div>
                        </div>`;

                if (app.executors && app.executors.length > 0) {
                    detailsHtml += `
                        <h4 style="margin: 20px 0 10px; color: #2c3e50;">Executors (${app.executors.length})</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 10px; text-align: left;">ID</th>
                                        <th style="padding: 10px; text-align: left;">Host</th>
                                        <th style="padding: 10px; text-align: left;">Cores</th>
                                        <th style="padding: 10px; text-align: left;">Memory Used</th>
                                        <th style="padding: 10px; text-align: left;">Tasks</th>
                                        <th style="padding: 10px; text-align: left;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    app.executors.forEach(executor => {
                        detailsHtml += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px;">${executor.id}</td>
                                <td style="padding: 8px;">${executor.hostPort || 'N/A'}</td>
                                <td style="padding: 8px;">${executor.totalCores || 0}</td>
                                <td style="padding: 8px;">${formatBytes((executor.memoryUsed || 0) * 1024 * 1024)}</td>
                                <td style="padding: 8px;">${executor.activeTasks || 0} / ${executor.maxTasks || 0}</td>
                                <td style="padding: 8px;">
                                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; background: ${executor.isActive ? '#e8f5e8' : '#ffebee'}; color: ${executor.isActive ? '#27ae60' : '#f44336'};">
                                        ${executor.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                            </tr>`;
                    });

                    detailsHtml += `
                                </tbody>
                            </table>
                        </div>`;
                }

                detailsHtml += `
                        <div style="text-align: right; margin-top: 20px;">
                            <button onclick="closeModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                        </div>
                    </div>`;

                showModal(detailsHtml);

            } catch (error) {
                console.error('Failed to view application details:', error);
                showError('Failed to load application details');
            }
        }

        async function downloadLogs(appId) {
            try {
                updateRefreshStatus('Downloading logs...');
                const response = await fetch(`/api/cluster/${currentCluster}/application/${appId}/download_logs`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${appId}_logs.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    updateRefreshStatus('Logs downloaded successfully');
                } else {
                    throw new Error('Failed to download logs');
                }
            } catch (error) {
                console.error('Failed to download logs:', error);
                showError('Failed to download logs');
            }
        }

        async function killApplication(appId) {
            if (!confirm(`Are you sure you want to kill application ${appId}?`)) {
                return;
            }

            try {
                updateRefreshStatus('Killing application...');
                const response = await fetch(`/api/cluster/${currentCluster}/kill_application/${appId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    updateRefreshStatus('Application killed successfully');
                    // Refresh data after 2 seconds
                    setTimeout(loadClusterData, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to kill application');
                }
            } catch (error) {
                console.error('Failed to kill application:', error);
                showError('Failed to kill application: ' + error.message);
            }
        }

        function showModal(content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                margin: 20px;
            `;
            modalContent.innerHTML = content;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            window.currentModal = modal;

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const existing = document.querySelector('.error');
            if (existing) existing.remove();

            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = message;

            document.querySelector('.container').insertBefore(error, document.querySelector('.cluster-selector').nextSibling);

            setTimeout(() => {
                if (error.parentNode) {
                    error.parentNode.removeChild(error);
                }
            }, 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function updateRefreshStatus(message) {
            const status = document.getElementById('refreshStatus');
            status.textContent = message + ' - ' + new Date().toLocaleTimeString();
        }

        // Auto-refresh functionality
        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                refreshInterval = setInterval(() => {
                    if (currentCluster) {
                        loadClusterData();
                    }
                }, 30000); // 30 seconds
                updateRefreshStatus('Auto-refresh enabled');
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                updateRefreshStatus('Auto-refresh disabled');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && window.currentModal) {
                closeModal();
            }
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                if (currentCluster) {
                    loadClusterData();
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>